<!doctype html>
<style>
  body{font-family:sans-serif}
  table{
    background:#aaa;
    border-spacing: 1
  }
  td{background: white;padding:5px;vertical-align:top}
  td span{display:block}
  td span b{margin-left:20px}
  .fail > td{background:#fcc}
  b.fail{background:red;color:white;padding:5px}

</style>
<body onload=test()>
<div id=main>
</div>
</body>
<script src=db.js></script>
<script>
  var db,
    current,
    tallyMap = {};

  function showResults() {
    var 
      tableHead = [ 
      '<thead><tr>',
          '<th>Test Name</th>',
          '<th>Description</th>',
          '<th>Result</th>',
          '</tr></thead>' ].join(''),

      which,
      tableBody = [],
      tableRow = [];

    for(var test in tallyMap) {
      which = tallyMap[test];

      tableRow = [
        test,
        which.description,
          ['<span>',
            which.fail.join('<b class=fail>Failed</b></span><span>'),
            which.fail.length ? '<b class=fail>Failed</b>' : '',
           '</span><span>',
            which.pass.join('<b class=pass>Passed</b></span><span>'),
            which.pass.length ? '<b class=pass>Passed</b>' : '',
           '</span>'
          ].join('')
      ];

      tableBody.push([
        '<tr class=' + (which.fail.length ? 'fail' : 'pass') + '>',
          '<td>' + tableRow.join('</td><td>') + '</td>',
        '</tr>'
      ].join(''));
    }

    document.getElementById('main').innerHTML += [
      '<table>',
      tableHead,
      tableBody.join(''),
      '</table>' 
    ].join('');
  }

  function assert(test) {
    current[ eval(test) ? 'pass' : 'fail' ].push(test);
  }

  function run(list) {
    if(list.constructor == Array) {
      var ret = true;

      for(var i = 0; i < list.length; i++) {
        ret &= run(list[i]);
      }

      return ret;
    } else {
      var which = list;

      if(tallyMap[which].fail.length) {
        current.fail.push("skipped. required test " + which + " failed.");
        return false;
      } else {
        tallyMap[which]();
        current.pass = [];
      }

      return tallyMap[which].fail.length == 0;
    }
  }

  function doTest(optList) {
    var which, obj;

    for (var ix=0; ix < optList.length; ix++) {
      which = optList[ix];

      if(!which.noreset) {
        db = DB();
      }

      obj = which.test;
      obj.pass = [];
      obj.fail = [];
      obj.description = which.description;
      tallyMap[which.name] = obj;

      current = obj;

      try {
        obj();
      } catch(ex) {
        obj.fail.push(ex.toSource());
      }
      obj.done = true;
    }

    showResults();
  }

  function test() {
    doTest([
      { name: 'insert-one', 
        description: 'insert {key: value}', 
        test: function() {
          db.insert({key: 'value'});
          assert('db.__raw__.length == 1');
          assert('db.__raw__[0].key == "value"');
        }
      },
      { name: 'insert-three', 
        description: 'insert [{key1: 0}, {key2: value2}, {key1: value3}]',
        test: function() {
          db.insert({key1: 0}, {key2: 'value2'}, {key1: 'value3'});
          assert('db.__raw__.length == 3');
          assert('db.__raw__[0].key1 == 0');
          assert('db.__raw__[1].key2 == "value2"');
          assert('db.__raw__[2].key1 == "value3"');
        }
      },
      { name: 'remove-all',
        description: 'insert-one then remove all',
        test: function() {
          run('insert-one');
          db.remove();
          assert('db.__raw__.length == 0');
        }
      },
      { name: 'remove-head',
        description: 'insert-three then remove {key1: 0}, first element',
        test: function() {
          run('insert-three');
          db.remove({key1: 0});
          assert('db.__raw__.length == 2');
          assert('db.__raw__[0].key2 == "value2"');
        }
      },
      { name: 'remove-middle',
        description: 'insert-three then remove {key2: value2}, middle element',
        test: function() {
          run('insert-three');
          db.remove({key2: 'value2'});
          assert('db.__raw__.length == 2');
          assert('db.__raw__[1].key1 == "value3"');
        }
      },
      { name: 'remove-tail',
        description: 'insert-three then remove {key1: value3}, last element',
        test: function() {
          run('insert-three');
          db.remove({key1: 'value3'});
          assert('db.__raw__.length == 2');
        }
      },
      { name: 'find-all',
        description: 'insert-one then find all',
        test: function() {
          run('insert-one');
          assert.res = db.find();
          assert('assert.res.length == 1');
        }
      },
      { name: 'find-one',
        description: 'insert-three then find {key1: 0}',
        test: function() {
          run('insert-three');
          assert.res = db.find({key1: 0});
          assert('assert.res.length == 1');
          assert('assert.res[0] == db.__raw__[0]');
        }
      },
      { name: 'find-key1',
        description: 'insert-three then find {key1: *}',
        test: function() {
          run('insert-three');
          assert.res = db.find({key1: db('!== undefined')});
          assert('assert.res.length == 2');
        }
      },
      { name: 'update-key1',
        description: 'find-key1, then update all key1 to be value4',
        test: function() {
          run('find-key1');
          assert.res.update({key1: 'value4'});
          assert('db.__raw__[0].key1 == "value4"');
          assert('db.__raw__[2].key1 == "value4"');
        }
      },
      { name: 'update-1',
        description: 'insert-three, then update all records to have key9 = false',
        test: function() {
          run('insert-three');
          db.update({key9: false});

          for(var i = 0; i < 3; i++) {
            assert('db.__raw__[' + i + '].key9 === false');
          }
        }
      },
      { name: 'remove-3',
        description: 'update-1, then remove all records of key9===false and key1=0',
        test: function() {
          run('update-1');
          db.find({
            key9: false,
            key1: 0
          }).remove();

          assert('db.__raw__.length == 2');
          assert('db.__raw__[0].key2 == "value2"');
          assert('db.__raw__[1].key1 == "value3"');
        }
      }
    ]);
  }
</script>
