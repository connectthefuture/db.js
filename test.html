<!doctype html>
<style>
body{font-family:monospace;margin:10px}
h4{margin:0.25em 0}
.log{
  border-radius: 6px;
  -webkit-border-radius: 6px;
  -moz-border-radius: 6px;
  background:#ddd;padding:10px;margin:0px 5px 17px 0;max-width:600px}
div span{margin:0 0.5em;display:block}
</style>
<body onload=test()>
<div id=main>
</div>
<p>
In order to do the performance test, you need to 
<ul>
<li>Run this from a webserver, such as apache or nginx
<li>Get the file  http://www.census.gov/popest/counties/files/CO-EST2009-ALLDATA.csv and
<ul>
<li>Rename it sample.csv
<li>Put it in the same directory as the test file
</ul>
</ul>
After all those steps are done, then you can click the button below:
</p>
<pre>
<button onclick=performance()>Run Performance Test</button>
</pre>
</body>
<script src=db.min.js></script>
<script>
  var db;

  window.DB.importCSV = function(url) {

    function get(url) {
      var req = new XMLHttpRequest();
      req.open('GET', url, false);
      req.send(null);
      if(req.status == 200) {
        return req.responseText;
      } else {
        return '';
      }
    }

    var 
      lineList = get(url).split('\n'),
      db = DB(),
      re = new RegExp('(?:"[^"]*")|(?:[^,]+)', "g"),
      record,
      match,
      field = 0,
      header = [],
      line = lineList.shift(),
      len = lineList.length;

    if(len === 0) {
      return;
    }

    while( ( match = re.exec(line) ) != null) {
      header.push(match[0]);
    }

    for(var ix = 0; ix < len; ix++) {
      record = {};
      line = lineList[ix];

      field = 0;

      while( ( match = re.exec(line) ) != null) {
        if(parseFloat(match[0]).toString() == match[0]) {
          record[ header[field] ] = parseFloat(match[0]);
        } else {
          record[ header[field] ] = match[0];
        }
        field ++;
      }

      if(field > 0) {
        db.insert(record);
      }
    }

    return db;
  }

  function performance() {
    function log(str) {
      document.body.getElementsByTagName('pre')[0].innerHTML += "<div>" + str + "</div>";
    }

    log("Importing 500K records from 2000 census");
    var db = DB.importCSV('sample.csv'),
       middle;

    function clock(name, callback) {
      var ret;

      start = new Date();
      ret = callback();
      end = new Date();

      log((end.getTime() - start.getTime()) + "ms (" + name + ")");

      return ret; 
    }

    middle = clock("Finding only the county and city records", function(){
      return db.find(db('STNAME', ' != record.CTYNAME'));
    });

    middle = clock('Grouping the records by state', function(){
      return middle.group('STNAME');
    });

    middle = clock('Accumulating the population per state', function(){
      return middle.each(DB.reduceLeft(0, ' += x.POPESTIMATE2000'));
    });

    var table = "<table><tr><td>state</td><td>2000 pop</td></tr>";
    for(var state in middle) {
      table += "<tr><td>" + state + "</td><td>" + middle[state] + "</td></tr>";
    }
    table += "</table>";
    log(table);  
  }

  function info(txt) {
    document.getElementById('main').innerHTML += '<div class=info>' +
      '<i>Notice: ' + arguments[0] + '</i>' + 
      '</div>';
  }
  function log(txt) {
    document.getElementById('main').innerHTML += '<div class=log>' +
      '<h4>' + arguments[0] + ':</h4>' + 
      '<span>' + arguments[1] + '</span>' +
      '</div>';
  }

  function test() {
    var res;

    db = DB([{
      first: "Peter",
      last: "Griffin",
      age: 41,
      hometown: "Quahog",
      job: "Brewer"
    }, {
      first: "Lois",
      last: "Griffin",
      age: 40,
      hometown: "Newport",
      job: "Piano Teacher"
    }]),

    toInsert = [{
      first: "Joseph",
      last: "Swanson",
      age: 39,
      hometown: "Quahog",
      job: "Police Officer"
    }, {
      first: "Glenn",
      last: "Quagmire",
      age: 41,
      hometown: "Quahog",
      job: "Pilot"
    }];

    res = db.find().select('*');
    log('Initialized the database with the following data', res.join('<br>'));

    db.sync( function(raw) {
      info('Running the synchronization function');
    });

    info('Registered a synchronization function to be run when the database changes');

    res = db.insert(toInsert);
    log('Inserted more data, got references to the data inserted back', res.join('<br>'));

    res = db.select('job');
    log('Showing the types of jobs', res.join('<br>'));

    res = db.find(db('age', '> 40')).select('first');
    log('Listing people with age over 40', res.join('<br>')); 

    res = db
      .order('age', 'asc')
      .select('first', 'age')
      .each(function(res) { return res[0] + ' is ' + res[1] });

    log('Ordering people by age ascending, and emitting output in a formatted way', res.join('<br>'));

    db.update('description', function(param) {
      return [ 
        param.first, 
        param.last, 
        "is from", 
        param.hometown, 
        "and is a",
        param.age, 
        "year old",
        param.job
      ].join(' ');
    });

    res = db.select('description');
    log('Created a new field, named description', res.join('<br>'));

    var removed = db.find('last', 'Griffin').remove();
    res = db.find('last', 'Griffin');
    log('Removed people with the last name griffin.  Searched for this parameter', res.length);

    db.insert(removed);
    res = db.find('last', 'Griffin');
    log('Reinserted the results previously removed.  Searched for the same parameter', res.length);

    res = db.find({age: db.isin([41, 40])}).select('description');
    log('Searching for people either 41 or 40', res.join('<br>'));

    // Not in IE we don't.
    if(!window.attachEvent) {
      var somenumber = Math.floor(Math.random() * 1000 * 1000 * 1000).toString(16);
      log('Using document.getElementsByTagName("*") with a find on the innerHTML value to turn the element below blue', somenumber);

      DB.find(
        document.getElementsByTagName('*'), 
        {innerHTML: somenumber})[0].style.color = 'blue';
    }

  }
</script>
