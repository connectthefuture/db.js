<!doctype html>
<style>
  table{
    background:#aaf;
    border-spacing: 1
  }
  td{background: white;padding:5px;vertical-align:top}
  td span{display:block}
  td span b{margin-left:20px}
  .fail > td{background:#faa}

</style>
<body onload=test()>
<div id=main>
</div>
</body>
<script src=db.js></script>
<script>
  var db,
    current,
    tallyMap = {};

  function showResults() {
    var 
      tableHead = [ 
      '<thead><tr>',
          '<th>Test Name</th>',
          '<th>Description</th>',
          '<th>Result</th>',
          '</tr></thead>' ].join(''),

      which,
      tableBody = [],
      tableRow = [];

    for(var test in tallyMap) {
      which = tallyMap[test];

      tableRow = [
        test,
        which.description,
          ['<span>',
            which.fail.join('<b class=fail>Failed</b></span><span>'),
            which.fail.length > 1 ? '<b class=fail>Failed</b>' : '',
           '</span><span>',
            which.pass.join('<b class=pass>Passed</b></span><span>'),
            which.pass.length > 1 ? '<b class=pass>Passed</b>' : '',
           '</span>'
          ].join('')
      ];

      tableBody.push([
        '<tr class=' + (which.fail.length ? 'fail' : 'pass') + '>',
          '<td>' + tableRow.join('</td><td>') + '</td>',
        '</tr>'
      ].join(''));
    }

    document.getElementById('main').innerHTML += [
      '<table>',
      tableHead,
      tableBody.join(''),
      '</table>' 
    ].join('');
  }

  function assert(test) {
    current[ eval(test) ? 'pass' : 'fail' ].push(test);
  }

  function run(list) {
    if(list.constructor == Array) {
      var ret = true;

      for(var i = 0; i < list.length; i++) {
        ret &= run(list[i]);
      }

      return ret;
    } else {
      var which = list;

      if(tallyMap[which].fail.length) {
        current.fail.push("skipped. required test " + which + " failed.");
      } else {
        tallyMap[which]();
      }

      return tallyMap[which].fail.length == 0;
    }
  }

  function doTest(optList) {
    var which, obj;

    for (var ix=0; ix < optList.length; ix++) {
      which = optList[ix];

      if(!which.noreset) {
        db = DB();
      }

      obj = which.test;
      obj.pass = [];
      obj.fail = [];
      obj.description = which.description;
      tallyMap[which.name] = obj;

      current = obj;

      try {
        obj();
      } catch(ex) {
        obj.fail.push(ex.toSource());
      }
    }

    showResults();
  }

  function test() {
    doTest([
      { name: 'insert-0', 
        description: 'insert {key: value}', 
        test: function() {
          db.insert({key: 'value'});
          assert('db.__raw__.length == 1');
          assert('db.__raw__[0].key == "value"');
        }
      },
      { name: 'insert-1', 
        description: 'insert [{key1: value1}, {key2: value2}]',
        test: function() {
          db.insert({key1: 'value1'}, {key2: 'value2'});
          assert('db.__raw__.length == 2');
          assert('db.__raw__[0].key1 == "value1"');
          assert('db.__raw__[1].key2 == "value2"');
        }
      },
      { name: 'remove-0',
        description: 'insert-0 then remove all',
        test: function() {
          run('insert-0');
          db.remove();
          assert('db.__raw__.length == 0');
        }
      },
      { name: 'remove-1',
        description: 'insert-1 then remove {key1: value1}',
        test: function() {
          run('insert-1');
          db.remove({key1: 'value1'});
          assert('db.__raw__.length == 1');
          assert('db.__raw__[0].key2 == "value2"');
        }
      },
      { name: 'find-0',
        description: 'insert-0 then find all',
        test: function() {
          run('insert-0');
          assert.res = db.find();
          assert('assert.res.length == 1');
        }
      },
      { name: 'find-1',
        description: 'insert-1 then find {key1: value1}',
        test: function() {
          run('insert-1');
          assert.res = db.find({key1: 'value1'});
          assert('assert.res.length == 1');
          assert('assert.res[0] == db.__raw__[0]');
        }
      }
    ]);
  }
</script>
