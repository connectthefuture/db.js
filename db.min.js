(function(){function z(a,d){var b=arguments.length,c=b==1?a:d,f,e={};h.isArr(c)?(b=c.length,f=function(a){for(var e=0;e<b;e++)if(n(a,c[e])>-1)return!0;return!1}):f=function(a){return n(a,c)>-1};return b==2?(e={},e[a]=f,e):f}function u(a){return a.length?m.call(a):q(a)}function A(){var a=m.call(arguments),d,b,c,f,e,g=u(h.isArr(this)?this:a.shift());a.length==2&&h.isStr(a[0])&&(c={},c[a[0]]=a[1],a=[o({},c)]);for(b=0;b<a.length;b++)if(d=a[b],h.isFun(d)){d=d.single;f=g.length;for(e=f-1;e>=0;e--)d(g[e])&&
(f-(e+1)&&(spliceix=e+1,g.splice(spliceix,f-spliceix)),f=e);spliceix=e+1;f-spliceix&&g.splice(spliceix,f-spliceix)}else l(d,function(a,b){if(h.isFun(b)){f=g.length;for(e=f-1;e>=0;e--)c=g[e],a in c&&b(c[a],c)&&(f-(e+1)&&(spliceix=e+1,g.splice(spliceix,f-spliceix)),f=e)}else{f=g.length;for(e=f-1;e>=0;e--)c=g[e],a in c&&c[a]===b&&(f-(e+1)&&(spliceix=e+1,g.splice(spliceix,f-spliceix)),f=e)}spliceix=e+1;f-spliceix&&g.splice(spliceix,f-spliceix)});return g}function B(a,d){var b,c=arguments.length,f,e={};
c==1?f=a:c==2&&(f=d);f=f.toString().toLowerCase();b=function(a){return a.toString().toLowerCase().search(f)>-1};return c==2?(e={},e[a]=b,e):b}function v(a){var d={x:a};return function(a,c){arguments.length==2&&(d[a]=c);return d[a]}}function r(a){var d={};l(a,function(a){d[a]=!0});return d}function q(a){var d=[],b;for(b in a)d.push(a[b]);return d}function o(a){for(var d,b,c,f,e=arguments.length,g=0;g<e;g++){d=arguments[g];for(var k in d)b=a[k],c=d[k],a!==c&&(c&&(c.constructor==Object||(f=h.isArr(c)))?
(f?(f=!1,b=b&&h.isArr(constructor)?b:[]):b=b&&b.constructor==Object?b:{},a[k]=o(b,c)):c!==void 0&&(a[k]=c))}return a}function C(a,d){var b=[],c;arguments.length==2?(c=a,a=d):c=this;if(h.isArr(c))b=w(c,a);else{var b={},f;for(f in c)h.isFun(c[f])||(b[f]=a.call(this,c[f]))}return b}var m=Array.prototype.slice,x=Object.prototype.toString,s={},y={},h={isFun:function(a){return!(!a||!a.constructor||!a.call||!a.apply)},isStr:function(a){return!!(a===""||a&&a.charCodeAt&&a.substr)},isArr:Array.prototype.isArray||
function(a){return x.call(a)==="[object Array]"},isObj:function(a){return a==null?String(a)=="object":x.call(a)==="[object Object]"||!0}},n=Array.prototype.indexOf?function(a,d){return a.indexOf(d)}:function(a,d){for(var b=a.length-1;b!=-1&&d!=a[b];b--);return b},D=Object.prototype.keys||function(a){var d=[],b;for(b in a)d.push(b);return d},w=Array.prototype.map?function(a,d){return a.map(d)}:function(a,d){for(var b=[],c=0,f=obj.length;c<f;c++)b.push(d(obj[c],c));return b},l=Array.prototype.forEach?
function(a,d){if(h.isArr(a))a.forEach(d);else for(var b in a)d(b,a[b])}:function(a,d){if(h.isArr(a))for(var b=0,c=a.length;b<c;b++)d(a[b],b);else for(b in a)d(b,a[b])};l("< <= > >= == === != !==".split(" "),function(a){y[a]=Function("rhs","return function(x) { return x"+a+"rhs }")});var E=function(){var a={};return function(d,b){var c,f=arguments.length,e=f==1?d:b,g={};e.length?e.length<20?(c=e.join(","),c=a[c]?a[c]:a[c]=new Function("x","return x=="+e.join("||x=="))):c=function(a){return n(e,a)>
-1}:c=h.isFun(e)?function(a){return n(e(),a)>-1}:e;return f==2?(g={},g[d]=c,g):c}}(),F=function(){var a=/^\s*([=<>!]+)['"]*(.*)$/,d,b={};return function(){return function(c,f){var e,g;if(h.isStr(c)){g=c;if(arguments.length==1)if(b[g])e=b[g];else{try{e=new Function("x, record","return x "+g)}catch(l){e={}}try{e.single=new Function("record","return "+c)}catch(j){}b[g]=e}arguments.length==2&&h.isStr(f)&&(e={},g=f,b[g]||(b[g]=(d=g.match(a))!==null?y[d[1]](d[2].replace(/['"]$/,"")):new Function("x, record",
"return x "+g)),e[c]=b[g]);return e}}}}();(function(){var a={},d=[(Math.random()*Math.pow(2,32)).toString(36),(Math.random()*Math.pow(2,32)).toString(36)].join(":"),b=0,c;a.stain=function(a){b++;c=d+b;for(var e=0,g=a.length;e<g;e++)a[e][c]=!0;return c};a.isStained=function(a){var b=a[c];b&&delete a[c];return b};return a})();var t=function(){var a={},d=0;a.stain=function(a){d++;for(var c=0,f=a.length;c<f;c++)a[c].constructor("i",d);return d};a.isStained=function(a){return a.constructor("i")==d};return a}();
stainer=t;var G=r("has isin group remove update where select find order each like".split(" "));self.DB=function(a){function d(a){return a}function b(){for(var a=0,c=k.length;a<c;a++)k[a].call(i,j)}function c(a){for(var c in G)a[c]=i[c];return a}function f(a){for(var c=[],b=0,e=a.length;b<e;b++)c[b]=j[a[b]];return c}var e={},g=0,k=[],j=[];j._indexCache={};var i=F();i.isin=E;i.has=z;i.like=B;i.each=C;i.group=function(a){var b={};filter=h.isArr(this)?this:i.find();l(filter,function(c){b[c[a]]||(b[c[a]]=
[]);b[c[a]].push(c)});return c(b)};i.sync=function(a){k.push(a)};i.order=function(a,c){var b,e=arguments.length,d;h.isFun(a)?b=a:h.isStr(a)&&(e==1?d="x - y":e==2&&(h.isStr(c)&&(c.toLowerCase()=="asc"?d="x - y":c.toLowerCase()=="desc"&&(d="y - x")),typeof d=="undefined"&&(d=c)),h.isStr(d)&&(d=s[d]?s[d]:s[d]=new Function("x,y","return "+d)),b=function(c,b){return d(c[a],b[a])});return(h.isArr(this)?this:i.find()).sort(b)};i.constrain=function(){var a=o,c=e,b;var d=arguments,f={};d.length==2?(f[d[0]]=
d[1],b=f):d.length==1&&(b=d[0]);e=a(c,b)};i.inverse=function(a){arguments.length==0&&h.isArr(this)&&(a=this);var b;b=j;var d=a;b=r(b);var d=r(d),e;for(e in d)b[e]&&delete b[e];b=D(b);return c(b)};i.where=i.find=function(){return c(A.apply(this,arguments.length?[j].concat(m.call(arguments)):[j]))};i.select=function(a){var b,d={};arguments.length>1?a=m.call(arguments):h.isStr(a)&&(a=[a]);b=h.isArr(this)?this:i.find();l(a,function(a,c){if(a=="*")d=w(b,q);else for(var e=0,f=b.length;e<f;e++)row=b[e],
a in row&&(f>1?(d[e]||(d[e]=[]),d[e][c]=row[a]):d[e]=row[a])});return c(q(d))};i.insert=function(a){var i=[],p=[],k=[];arguments.length>1?p=m.call(arguments):h.isArr(a)?p=a:p.push(a);e.unique&&(i=db.find().select(e.unique));l(p,function(a){if(!(e.unique&&n(i,a[e.unique])!=-1)){var b=g++,c;try{c=new (v(b)),o(c,a),j.push(c)}catch(d){if(!unsafe)a.constructor=v(b);j.push(a)}k.push(b)}});b();return c(d(f(k)))};i.update=function(a,d){var e,f;e=h.isArr(this)?u(this):i.find();arguments.length==2&&h.isStr(a)&&
(f=a,a={},a[f]=d);l(a,function(a,b){h.isFun(b)?l(e,function(c){c[a]=b(c)}):l(e,function(c){c[a]=b})});b();return c(e)};i.remove=function(a){var d,e,f=[];d=h.isArr(this)?this:h.isArr(a)?a:arguments.length>0?i.find(a):i.find();t.stain(d);d=j.length;for(var g=j.length-1;g>=0;g--)t.isStained(j[g])?f.push(j[g]):(d-(g+1)&&(e=g+1,j.splice(e,d-e)),d=g);e=g+1;d-e&&j.splice(e,d-e);b();return c(f)};if(arguments.length==1)if(h.isArr(a))i.insert(a);else if(h.isFun(a))i.insert(a());else if(h.isStr(a))return i.apply(this,
arguments);else h.isObj(a)&&i.insert(a);else arguments.length>1&&i.insert(m.call(arguments));i.__raw__=j;return i}})();
