(function(){function E(a){var c={};m(a,function(a){c[a]=!0});return c}function F(a,c){var d=arguments.length,b=d==1?a:c,g,e={};i.isArr(b)?(d=b.length,g=function(a){for(var e=0;e<d;e++)if(q(a,b[e])>-1)return!0;return!1}):g=function(a){return q(a,b)>-1};return d==2?(e={},e[a]=g,e):g}function G(a){return a.length?n.call(a):s(a)}function w(){var a=n.call(arguments),c,d,b,g,e,f,h,k=G(i.isArr(this)?this:a.shift());a.length==2&&i.isStr(a[0])&&(b={},b[a[0]]=a[1],a=[p({},b)]);for(d=0;d<a.length;d++)if(c=a[d],
i.isFun(c)){c=c.single||c;for(e=k.length,h=e-1;h>=0;h--)b=k[h],c(b)&&(e-(h+1)&&(f=h+1,k.splice(f,e-f)),e=h);f=h+1;e-f&&k.splice(f,e-f)}else m(c,function(a,d){if(i.isFun(d))for(e=k.length,h=e-1;h>=0;h--)b=k[h],a in b&&(g=b[a],d(g,b)&&(e-(h+1)&&(f=h+1,k.splice(f,e-f)),e=h));else for(e=k.length,h=e-1;h>=0;h--)b=k[h],a in b&&b[a]===d&&(e-(h+1)&&(f=h+1,k.splice(f,e-f)),e=h);f=h+1;e-f&&k.splice(f,e-f)});return k}function x(){var a=E(n.call(arguments));return function(c){for(var d in a)if(d in c)return!1;
return!0}}function y(a,c){var d,b=arguments.length,g,e={};b==1?g=a:b==2&&(g=c);g=g.toString().toLowerCase();d=function(a){return a.toString().toLowerCase().search(g)>-1};return b==2?(e={},e[a]=d,e):d}function z(a){var c={x:a};return function(a,b){arguments.length==2&&(c[a]=b);return c[a]}}function s(a){var c=[],d;for(d in a)c.push(a[d]);return c}function H(a,c){var d,b=this;c!==A&&(d=a,a={},a[d]=c);i.isFun(a)?m(b,a):m(a,function(a,d){i.isFun(d)?m(b,function(b){b[a]=d(b)}):m(b,function(b){b[a]=d})});
return this}function p(a,c){for(var d,b,g,e,f=arguments.length,h=0;h<f;h++){d=arguments[h];for(var k in d)b=a[k],g=d[k],a!==g&&(g&&(g.constructor==Object||(e=i.isArr(g)))?(e?(e=!1,b=b&&i.isArr(constructor)?b:[]):b=b&&b.constructor==Object?b:{},a[k]=p(b,g)):g!==A&&(a[k]=g))}return a}function t(a,c){var d=[],b;arguments.length==2?(b=a,a=c):b=this;if(i.isArr(b))d=B(b,a);else{var d={},g;for(g in b)i.isFun(b[g])||(d[g]=a.call(this,b[g]))}return d}function C(a){r++;for(var c=0,d=a.length;c<d;c++)a[c].constructor("i",
r)}var A,n=Array.prototype.slice,u=Object.prototype.toString,v={},D={},r=0,i={isFun:function(a){return!(!a||!a.constructor||!a.call||!a.apply)},isStr:function(a){return!!(a===""||a&&a.charCodeAt&&a.substr)},isNum:function(a){return u.call(a)==="[object Number]"},isArr:[].isArray||function(a){return u.call(a)==="[object Array]"},isObj:function(a){return a==null?String(a)=="object":u.call(a)==="[object Object]"||!0}},q=[].indexOf?function(a,c){return a.indexOf(c)}:function(a,c){for(var d=a.length-1;d!=
-1&&c!=a[d];d--);return d},B=[].map?function(a,c){return a.map(c)}:function(a,c){for(var d=[],b=0,g=obj.length;b<g;b++)d.push(c(obj[b],b));return d},m=[].forEach?function(a,c){if(i.isArr(a))a.forEach(c);else for(var d in a)c(d,a[d])}:function(a,c){if(i.isArr(a))for(var d=0,b=a.length;d<b;d++)c(a[d],d);else for(d in a)c(d,a[d])};m("< <= > >= == === != !==".split(" "),function(a){D[a]=Function("rhs","return function(x){return x"+a+"rhs}")});var I=function(){var a={};return function(c,d){var b,g=arguments.length,
e=g==1?c:d||[],f={};e.length?e.length<20&&i.isNum(e[0])?(b=e.join(","),b=a[b]?a[b]:a[b]=new Function("x","return x=="+e.join("||x=="))):b=function(a){return q(e,a)>-1}:b=i.isFun(e)?function(a){return q(e(),a)>-1}:e;return g==2?(f={},f[c]=b,f):b}}(),J=function(){var a=/^\s*([=<>!]+)['"]*(.*)$/,c,d={};return function(){return function(b,g){var e,f;if(i.isStr(b)){f=b;if(arguments.length==1)if(d[f])e=d[f];else{try{e=new Function("x,rec","return x "+f)}catch(h){e={}}try{e.single=new Function("rec","return "+
b)}catch(k){}d[f]=e}arguments.length==2&&i.isStr(g)&&(e={},f=g,d[f]||(d[f]=(c=f.match(a))!==null?D[c[1]](c[2].replace(/['"]$/,"")):new Function("x,rec","return x "+f)),e[b]=d[f]);return e}}}}(),K=function(a){var c={};m(a,function(a){c[a]=!0});return c}("has hasKey invert missing isin group remove update where select find sort order each like".split(" "));self.DB=function(a,c){function d(){h||(h=!0,m(f,function(a){a.call(j,l)}),h=!1)}function b(a){for(var b in K)a[b]=j[b];return a}function g(a){for(var b=
[],d=0,e=a.length;d<e;d++)b[d]=l[a[d]];return b}var e={},f=[],h=!1,k=!1,j=J(),l=[];p(j,{__raw__:l,constrain:function(){var a=p,b=e,d;var c=arguments,o={};c.length==2?(o[c[0]]=c[1],d=o):c.length==1&&(d=c[0]);a(b,d)},each:t,findFirst:function(){var a=j.find.apply(this,n.call(arguments));return a.length?a[0]:{}},has:F,hasKey:function(){return j.find(x.apply(this,n.call(arguments))).invert()},isin:I,like:y,invert:function(a){var d=l,c=[];C(a||this);for(var a=0,e=d.length;a<e;a++)d[a].constructor("i")!=
r&&c.push(d[a]);return b(c)},map:t,missing:function(){return j.find(x.apply(this,n.call(arguments)))},sync:function(a){f.push(a)},template:{create:function(a){k=a},update:function(a){p(k||{},a)},get:function(){return k},destroy:function(){k=!1}},update:function(){var a=H.apply(i.isArr(this)?this:j.find(),n.call(arguments));d();return b(a)}});j.group=function(a){var d={},c=i.isArr(this)?this:j.find();m(c,function(b){d[b[a]]||(d[b[a]]=[]);d[b[a]].push(b)});return b(d)};j.order=j.sort=function(a,d){var c,
e=arguments.length,o,g=i.isArr(this)?this:j.find();i.isFun(a)?c=a:i.isStr(a)&&(e==1?o="x-y":e==2&&(o=i.isStr(d)?{asc:"x-y",desc:"y-x"}[d.toLowerCase()]:d),i.isStr(o)&&(o=v[o]?v[o]:v[o]=new Function("x,y","return "+o)),c=function(d,b){return o(d[a],b[a])});return b(n.call(g).sort(c))};j.where=j.find=function(){return b(w.apply(this,arguments.length?[l].concat(n.call(arguments)):[l]))};j.view=function(a){var b={};j.sync(function(d){var c={},e;m(d,function(b){a in b&&(c[b[a]]=b)});for(e in c)e in b?
b[e]!==c[e]&&(b[e]=c[e]):b[e]=c[e];for(e in b)e in c||delete b[e]});d();return b};j.select=function(a){var d=i.isArr(this)?this:j.find(),c={};arguments.length>1?a=n.call(arguments):i.isStr(a)&&(a=[a]);m(a,function(a,b){if(a=="*")c=B(d,s);else for(var e=0,g=d.length;e<g;e++)row=d[e],a in row&&(g>1?(c[e]||(c[e]=[]),c[e][b]=row[a]):c[e]=row[a])});return b(s(c))};j.insert=function(a){var c={},f=[],h=[];arguments.length>1?f=n.call(arguments):i.isArr(a)?f=a:f.push(a);e.unique&&m(l,function(a,b){c[a[e.unique]]=
b});m(f,function(a){if(e.unique&&a[e.unique]in c)h.push(c[a[e.unique]]);else{var b=l.length,d;if(k){var g={};m(k,function(a,b){g[a]=i.isFun(b)?b():b});a=p(g,a)}try{d=new (z(b)),p(d,a),l.push(d)}catch(f){a.constructor=z(b),l.push(a)}h.push(b)}});d();return b(g(h))};j.remove=function(a){var c,e,g=[];c=i.isArr(this)?this:i.isArr(a)?a:arguments.length>0?j.find(a):j.find();C(c);var f=l.length-1;for(c=l.length;f>=0;f--)l[f].constructor("i")==r?g.push(l[f]):(c-(f+1)&&(e=f+1,l.splice(e,c-e)),c=f);e=f+1;c-
e&&l.splice(e,c-e);d();return b(g)};if(arguments.length==1)if(i.isArr(a))j.insert(a);else if(i.isFun(a))j.insert(a());else if(i.isStr(a))return j.apply(this,arguments);else i.isObj(a)&&j.insert(a);else arguments.length>1&&j.insert(n.call(arguments));return j};p(DB,{find:w,each:t,like:y,reduceLeft:function(a,c){var d=i.isStr(c)?new Function("y,x","return y "+c):c;return function(b){for(var c=a,e=0,f=b.length;e<f;e++)b[e]&&(c=d(c,b[e]));return c}},reduceRight:function(a,c){c=DB.reduceLeft(a,c);return function(a){return c(a.reverse())}}})})();
