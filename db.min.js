(function(){function l(a,d){if(i.isArr(a))for(var c=0,b=a.length;c<b;c++)d(a[c],c);else for(c in a)d(c,a[c])}function o(a){var d=[],c;for(c in a)d.push(a[c]);return d}function t(a,d){var c=arguments.length,b,e,g={};c==1?e=a:c==2&&(e=d);i.isArr(e)?(c=e.length,b=function(a){for(ix=0;ix<c;ix++)if(m(a,e[ix])>-1)return!0;return!1}):b=function(a){return m(a,e)>-1};return c==2?(g={},g[a]=b,g):b}function u(a){return i.isArr(a)?a.slice():o(a)}function v(){var a=n.call(arguments),d,c,b;c=i.isArr(this);var e,
g,f,j=u(c?this:a.shift());a.length==2&&i.isStr(a[0])&&(b={},b[a[0]]=a[1],a=[p({},b)]);for(c=0;c<a.length;c++)if(d=a[c],i.isFun(d)){d=d.single;e=j.length;for(f=e-1;f>=0;f--)d(j[f])&&(e-(f+1)&&(g=f+1,j.splice(g,e-g)),e=f);g=f+1;e-g&&j.splice(g,e-g)}else l(d,function(a,c){if(i.isFun(c)){e=j.length;for(f=e-1;f>=0;f--)b=j[f],a in b&&c(b[a],b)&&(e-(f+1)&&(g=f+1,j.splice(g,e-g)),e=f)}else{e=j.length;for(f=e-1;f>=0;f--)b=j[f],a in b&&b[a]===c&&(e-(f+1)&&(g=f+1,j.splice(g,e-g)),e=f)}g=f+1;e-g&&j.splice(g,
e-g)});return j}function w(a,d){var c,b=arguments.length,e,g={};b==1?e=a:b==2&&(e=d);e=e.toString().toLowerCase();c=function(a){return a.toString().toLowerCase().search(e)>-1};return b==2?(g={},g[a]=c,g):c}function x(){var a={};return function(d,c){if(arguments.length==1)return a[d];arguments.length==2&&(a[d]=c)}}function q(a){var d={};l(a,function(a){d[a]=!0});return d}function p(a){for(var d,c,b,e,g=arguments.length,f=0;f<g;f++){d=arguments[f];for(var j in d)c=a[j],b=d[j],a!==b&&(b&&(b.constructor==
Object||(e=i.isArr(b)))?(e?(e=!1,c=c&&i.isArr(constructor)?c:[]):c=c&&c.constructor==Object?c:{},a[j]=p(c,b)):b!==void 0&&(a[j]=b))}return a}function y(a,d){var c=[],b;arguments.length==2?(b=a,a=d):b=this;if(i.isObj(b)){var c={},e;for(e in b)i.isFun(b[e])||(c[e]=a.call(this,b[e]))}else l(b,function(){c.push(a.apply(this,arguments))});return c}var n=Array.prototype.slice,z=Object.prototype.toString,A=[],r=!1,s={},i={isFun:function(a){return!(!a||!a.constructor||!a.call||!a.apply)},isStr:function(a){return!!(a===
""||a&&a.charCodeAt&&a.substr)},isArr:A.isArr?Array.isArr:function(a){return z.call(a)==="[object Array]"},isObj:function(a){return a==null?String(a)=="object":z.call(a)==="[object Object]"||!0}},m=A.indexOf?function(a,d){return a.indexOf(d)}:function(a,d){for(var c=a.length-1;c!=-1&&d!=a[c];c--);return c},B=function(){var a={};return function(d,c){var b,e=arguments.length,g=e==1?d:c,f={};if(g.length)if(r&&g.length<10){var j=RegExp("^("+g.join("|")+")$");b=function(a){return j.test(a)}}else g.length<
20?(b=g.join(","),b=a[b]?a[b]:a[b]=new Function("x","return x=="+g.join("||x=="))):b=function(a){return m(g,a)>-1};else b=i.isFun(g)?function(a){return m(g(),a)>-1}:g;return e==2?(f={},f[d]=b,f):b}}(),D=Object.keys?Object.keys:function(a){var d=[],c;for(c in a)d.push(c);return d},E=function(){var a={};return function(){return function(d,c){var b,e;if(i.isStr(d)){e=d;if(arguments.length==1)if(a[e])b=a[e];else{try{b=new Function("x, record","return x "+e)}catch(g){b={}}try{b.single=new Function("record",
"return "+d)}catch(f){}a[e]=b}arguments.length==2&&i.isStr(c)&&(b={},e=c,a[e]||(a[e]=new Function("x, record","return x "+e)),b[d]=a[e]);return b}}}}(),F=function(){var a={},d=[(Math.random()*Math.pow(2,32)).toString(36),(Math.random()*Math.pow(2,32)).toString(36)].join(":"),c=0,b;a.stain=function(a){c++;b=d+c;for(var g=0,f=a.length;g<f;g++)a[g][b]=!0;return b};a.isStained=function(a){var c=a[b];c&&delete a[b];return c};return a}(),C=function(){var a={},d=0;a.stain=function(a){d++;for(var b=0,e=a.length;b<
e;b++)a[b].constructor("i",d);return d};a.isStained=function(a){return a.constructor("i")==d};return a}();stainer=C;var G=q("has isin map group remove update where select find order each like ilike".split(" "));self.DB=function(a){function d(){for(var a=0,c=f.length;a<c;a++)f[ix].call(h,k)}function c(a){for(var c in G)a[c]=h[c];return a}function b(a){for(var c=0,b=a.length,e=[];c<b;c++)e[c]=k[a[c]];return e}var e={},g=0,f=[],j=r?F:C,k=[],h=E();h.isin=B;h.has=t;h.ilike=h.like=w;h.each=y;h.map=q;h.group=
function(a){var b={};filter=i.isArr(this)?this:h.find();l(filter,function(c){b[c[a]]||(b[c[a]]=[]);b[c[a]].push(c)});return c(b)};h.sync=function(a){f.push(a)};h.order=function(a,c){var b,e=arguments.length,d;i.isFun(a)?b=a:i.isStr(a)&&(e==1?d="x - y":e==2&&(i.isStr(c)&&(c.toLowerCase()=="asc"?d="x - y":c.toLowerCase()=="desc"&&(d="y - x")),typeof d=="undefined"&&(d=c)),i.isStr(d)&&(d=s[d]?s[d]:s[d]=new Function("x,y","return "+d)),b=function(c,b){return d(c[a],b[a])});return(i.isArr(this)?this:h.find()).sort(b)};
h.constrain=function(){var a=p,c=e,b;var d=arguments,g={};d.length==2?(g[d[0]]=d[1],b=g):d.length==1&&(b=d[0]);e=a(c,b)};h.inverse=function(a){arguments.length==0&&i.isArr(this)&&(a=this);var b;b=k;var d=a;b=q(b);var d=q(d),e;for(e in d)b[e]&&delete b[e];b=D(b);return c(b)};h.where=h.find=function(){return c(v.apply(this,arguments.length?[k].concat(n.call(arguments)):[k]))};h.select=function(a){var b,d={};arguments.length>1?a=n.call(arguments):i.isStr(a)&&(a=[a]);b=i.isArr(this)?this:h.find();l(a,
function(a){for(var c=0,e=b.length;c<e;c++)row=b[c],a=="*"?d[c]=o(row):a in row&&(e>1?(d[c]||(d[c]=[]),d[c][iy]=row[a]):d[c]=row[a])});return c(o(d))};h.insert=function(a){var f=[],h=[],j=[];arguments.length>1?h=n.call(arguments):i.isArr(a)?h=a:h.push(a);e.unique&&(f=db.find().select(e.unique));l(h,function(a){if(!(e.unique&&m(f,a[e.unique])!=-1)){var c=g++,b;try{r?k.push(a):(b=new (x()),p(b,a),k.push(b))}catch(d){if(!unsafe)a.constructor=x();k.push(a)}j.push(c)}});d();return c(b(j))};h.update=function(a,
b){var e,g;e=i.isArr(this)?u(this):h.find();arguments.length==2&&i.isStr(a)&&(g=a,a={},a[g]=b);l(a,function(a,c){i.isFun(c)?l(e,function(b){b[a]=c(b)}):l(e,function(b){b[a]=c})});d();return c(e)};h.remove=function(a){var b,e,g=[];b=i.isArr(this)?this:i.isArr(a)?a:arguments.length>0?h.find(a):h.find();j.stain(b);b=k.length;for(var f=k.length-1;f>=0;f--)j.isStained(k[f])?g.push(k[f]):(b-(f+1)&&(e=f+1,k.splice(e,b-e)),b=f);e=f+1;b-e&&k.splice(e,b-e);d();return c(g)};if(arguments.length==1)if(i.isArr(a))h.insert(a);
else if(i.isFun(a))h.insert(a());else if(i.isStr(a))return h.apply(this,arguments);else i.isObj(a)&&h.insert(a);else arguments.length>1&&h.insert(n.call(arguments));h.__raw__=k;return h};self.DB.isin=B;self.DB.find=v;self.DB.has=t;self.DB.each=y;self.DB.values=o;self.DB.ilike=self.DB.like=w;self.DB.unsafe=function(){r=!0};self.DB.reduceLeft=function(a,d){var c=new Function("ref,x","return ref "+d);return function(b){for(var e=b.length,d=a,f=0;f<e;f++)b[f]&&(d=c(d,b[f]));return d}};self.DB.reduceRight=
function(a,d){var c=new Function("ref,x","return ref "+d);return function(b){for(var e=a,d=b.length-1;d>0;d--)e=c(e,b[d]);return e}}})();
