(function(){function t(a,d){var c=arguments.length,b=c==1?a:d,e,f={};h.isArr(b)?(c=b.length,e=function(a){for(ix=0;ix<c;ix++)if(n(a,b[ix])>-1)return!0;return!1}):e=function(a){return n(a,b)>-1};return c==2?(f={},f[a]=e,f):e}function u(a){return a.length?m.call(a):o(a)}function v(){var a=m.call(arguments),d,c,b,e,f,g=u(h.isArr(this)?this:a.shift());a.length==2&&h.isStr(a[0])&&(b={},b[a[0]]=a[1],a=[p({},b)]);for(c=0;c<a.length;c++)if(d=a[c],h.isFun(d)){d=d.single;e=g.length;for(f=e-1;f>=0;f--)d(g[f])&&
(e-(f+1)&&(spliceix=f+1,g.splice(spliceix,e-spliceix)),e=f);spliceix=f+1;e-spliceix&&g.splice(spliceix,e-spliceix)}else l(d,function(a,c){if(h.isFun(c)){e=g.length;for(f=e-1;f>=0;f--)b=g[f],a in b&&c(b[a],b)&&(e-(f+1)&&(spliceix=f+1,g.splice(spliceix,e-spliceix)),e=f)}else{e=g.length;for(f=e-1;f>=0;f--)b=g[f],a in b&&b[a]===c&&(e-(f+1)&&(spliceix=f+1,g.splice(spliceix,e-spliceix)),e=f)}spliceix=f+1;e-spliceix&&g.splice(spliceix,e-spliceix)});return g}function w(a,d){var c,b=arguments.length,e,f={};
b==1?e=a:b==2&&(e=d);e=e.toString().toLowerCase();c=function(a){return a.toString().toLowerCase().search(e)>-1};return b==2?(f={},f[a]=c,f):c}function x(){var a={};return function(d,c){if(arguments.length==1)return a[d];arguments.length==2&&(a[d]=c)}}function r(a){var d={};l(a,function(a){d[a]=!0});return d}function o(a){var d=[],c;for(c in a)d.push(a[c]);return d}function p(a){for(var d,c,b,e,f=arguments.length,g=0;g<f;g++){d=arguments[g];for(var k in d)c=a[k],b=d[k],a!==b&&(b&&(b.constructor==Object||
(e=h.isArr(b)))?(e?(e=!1,c=c&&h.isArr(constructor)?c:[]):c=c&&c.constructor==Object?c:{},a[k]=p(c,b)):b!==void 0&&(a[k]=b))}return a}function y(a,d){var c=[],b;arguments.length==2?(b=a,a=d):b=this;if(h.isArr(b))c=z(b,a);else{var c={},e;for(e in b)h.isFun(b[e])||(c[e]=a.call(this,b[e]))}return c}var m=Array.prototype.slice,A=Object.prototype.toString,q=!1,s={},h={isFun:function(a){return!(!a||!a.constructor||!a.call||!a.apply)},isStr:function(a){return!!(a===""||a&&a.charCodeAt&&a.substr)},isArr:Array.prototype.isArray||
function(a){return A.call(a)==="[object Array]"},isObj:function(a){return a==null?String(a)=="object":A.call(a)==="[object Object]"||!0}},n=Array.prototype.indexOf?function(a,d){return a.indexOf(d)}:function(a,d){for(var c=a.length-1;c!=-1&&d!=a[c];c--);return c},D=Object.prototype.keys||function(a){var d=[],c;for(c in a)d.push(c);return d},z=Array.prototype.map?function(a,d){return a.map(d)}:function(a,d){for(var c=[],b=0,e=obj.length;b<e;b++)c.push(d(obj[b],b));return c},l=Array.prototype.forEach?
function(a,d){if(h.isArr(a))a.forEach(d);else for(var c in a)d(c,a[c])}:function(a,d){if(h.isArr(a))for(var c=0,b=a.length;c<b;c++)d(a[c],c);else for(c in a)d(c,a[c])},B=function(){var a={};return function(d,c){var b,e=arguments.length,f=e==1?d:c,g={};if(f.length)if(q&&f.length<10){var k=RegExp("^("+f.join("|")+")$");b=function(a){return k.test(a)}}else f.length<20?(b=f.join(","),b=a[b]?a[b]:a[b]=new Function("x","return x=="+f.join("||x=="))):b=function(a){return n(f,a)>-1};else b=h.isFun(f)?function(a){return n(f(),
a)>-1}:f;return e==2?(g={},g[d]=b,g):b}}(),E=function(){var a={};return function(){return function(d,c){var b,e;if(h.isStr(d)){e=d;if(arguments.length==1)if(a[e])b=a[e];else{try{b=new Function("x, record","return x "+e)}catch(f){b={}}try{b.single=new Function("record","return "+d)}catch(g){}a[e]=b}arguments.length==2&&h.isStr(c)&&(b={},e=c,a[e]||(a[e]=new Function("x, record","return x "+e)),b[d]=a[e]);return b}}}}(),F=function(){var a={},d=[(Math.random()*Math.pow(2,32)).toString(36),(Math.random()*
Math.pow(2,32)).toString(36)].join(":"),c=0,b;a.stain=function(a){c++;b=d+c;for(var f=0,h=a.length;f<h;f++)a[f][b]=!0;return b};a.isStained=function(a){var c=a[b];c&&delete a[b];return c};return a}(),C=function(){var a={},d=0;a.stain=function(a){d++;for(var b=0,e=a.length;b<e;b++)a[b].constructor("i",d);return d};a.isStained=function(a){return a.constructor("i")==d};return a}();stainer=C;var G=r("has isin group remove update where select find order each like".split(" "));self.DB=function(a){function d(){for(var a=
0,c=g.length;a<c;a++)g[a].call(i,j)}function c(a){for(var c in G)a[c]=i[c];return a}function b(a){for(var c=0,b=a.length,e=[];c<b;c++)e[c]=j[a[c]];return e}var e={},f=0,g=[],k=q?F:C,j=[],i=E();i.isin=B;i.has=t;i.like=w;i.each=y;i.group=function(a){var b={};filter=h.isArr(this)?this:i.find();l(filter,function(c){b[c[a]]||(b[c[a]]=[]);b[c[a]].push(c)});return c(b)};i.sync=function(a){g.push(a)};i.order=function(a,c){var b,e=arguments.length,d;h.isFun(a)?b=a:h.isStr(a)&&(e==1?d="x - y":e==2&&(h.isStr(c)&&
(c.toLowerCase()=="asc"?d="x - y":c.toLowerCase()=="desc"&&(d="y - x")),typeof d=="undefined"&&(d=c)),h.isStr(d)&&(d=s[d]?s[d]:s[d]=new Function("x,y","return "+d)),b=function(c,b){return d(c[a],b[a])});return(h.isArr(this)?this:i.find()).sort(b)};i.constrain=function(){var a=p,c=e,b;var d=arguments,f={};d.length==2?(f[d[0]]=d[1],b=f):d.length==1&&(b=d[0]);e=a(c,b)};i.inverse=function(a){arguments.length==0&&h.isArr(this)&&(a=this);var b;b=j;var d=a;b=r(b);var d=r(d),e;for(e in d)b[e]&&delete b[e];
b=D(b);return c(b)};i.where=i.find=function(){return c(v.apply(this,arguments.length?[j].concat(m.call(arguments)):[j]))};i.select=function(a){var b,d={};arguments.length>1?a=m.call(arguments):h.isStr(a)&&(a=[a]);b=h.isArr(this)?this:i.find();l(a,function(a,c){if(a=="*")d=z(b,o);else for(var e=0,f=b.length;e<f;e++)row=b[e],a in row&&(f>1?(d[e]||(d[e]=[]),d[e][c]=row[a]):d[e]=row[a])});return c(o(d))};i.insert=function(a){var g=[],i=[],k=[];arguments.length>1?i=m.call(arguments):h.isArr(a)?i=a:i.push(a);
e.unique&&(g=db.find().select(e.unique));l(i,function(a){if(!(e.unique&&n(g,a[e.unique])!=-1)){var b=f++,c;try{q?j.push(a):(c=new (x()),p(c,a),j.push(c))}catch(d){if(!unsafe)a.constructor=x();j.push(a)}k.push(b)}});d();return c(b(k))};i.update=function(a,b){var e,f;e=h.isArr(this)?u(this):i.find();arguments.length==2&&h.isStr(a)&&(f=a,a={},a[f]=b);l(a,function(a,b){h.isFun(b)?l(e,function(c){c[a]=b(c)}):l(e,function(c){c[a]=b})});d();return c(e)};i.remove=function(a){var b,e,f=[];b=h.isArr(this)?
this:h.isArr(a)?a:arguments.length>0?i.find(a):i.find();k.stain(b);b=j.length;for(var g=j.length-1;g>=0;g--)k.isStained(j[g])?f.push(j[g]):(b-(g+1)&&(e=g+1,j.splice(e,b-e)),b=g);e=g+1;b-e&&j.splice(e,b-e);d();return c(f)};if(arguments.length==1)if(h.isArr(a))i.insert(a);else if(h.isFun(a))i.insert(a());else if(h.isStr(a))return i.apply(this,arguments);else h.isObj(a)&&i.insert(a);else arguments.length>1&&i.insert(m.call(arguments));i.__raw__=j;return i};self.DB.isin=B;self.DB.find=v;self.DB.has=t;
self.DB.each=y;self.DB.values=o;self.DB.like=w;self.DB.unsafe=function(){q=!0};self.DB.reduceLeft=function(a,d){var c=new Function("y,x","return y "+d);return function(b){for(var e=b.length,d=a,g=0;g<e;g++)b[g]&&(d=c(d,b[g]));return d}};self.DB.reduceRight=function(a,d){var c=new Function("y,x","return y "+d);return function(b){for(var e=a,d=b.length-1;d>0;d--)e=c(e,b[d]);return e}}})();
