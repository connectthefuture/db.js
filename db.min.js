(function(){function E(a){var c={};j(a,function(a){c[a]=!0});return c}function F(a,c){var d=arguments.length,b=d==1?a:c,e,f={};h.isArr(b)?(d=b.length,e=function(a){for(var c=0;c<d;c++)if(p(a,b[c])>-1)return!0;return!1}):e=function(a){return p(a,b)>-1};return d==2?(f={},f[a]=e,f):e}function r(){var a=m.call(arguments),c,d,b,e,f=[],g,l=h.isArr(this)?this:a.shift();a.length==2&&h.isStr(a[0])&&(b={},b[a[0]]=a[1],a=[n({},b)]);for(d=0;d<a.length;d++)if(c=a[d],h.isFun(c)){c=c.single||c;for(e=0,g=l.length;e<
g;e++)b=l[e],c(b)&&f.push(b)}else j(c,function(a,d){if(h.isFun(d))for(e=0,g=l.length;e<g;e++)b=l[e],a in b&&d(b[a],b)&&f.push(b);else for(e=0,g=l.length;e<g;e++)b=l[e],a in b&&b[a]===d&&f.push(b)});return f}function v(){var a=E(m.call(arguments));return function(c){for(var d in a)if(d in c)return!1;return!0}}function w(a,c){var d,b=arguments.length,e,f={};b==1?e=a:b==2&&(e=c);e=e.toString().toLowerCase();d=function(a){return a.toString().toLowerCase().search(e)>-1};return b==2?(f={},f[a]=d,f):d}function x(a){var c=
{x:a};return function(a,b){arguments.length==2&&(c[a]=b);return c[a]}}function y(a){var c=[],d;for(d in a)c.push(a[d]);return c}function G(a,c){var d,b=this;c!==z&&(d=a,a={},a[d]=c);h.isFun(a)?j(b,a):j(a,function(a,d){h.isFun(d)?j(b,function(b){b[a]=d(b)}):j(b,function(b){b[a]=d})});return this}function n(a,c){for(var d,b,e,f,g=arguments.length,l=0;l<g;l++){d=arguments[l];for(var j in d)b=a[j],e=d[j],a!==e&&(e&&(e.constructor==Object||(f=h.isArr(e)))?(f?(f=!1,b=b&&h.isArr(constructor)?b:[]):b=b&&
b.constructor==Object?b:{},a[j]=n(b,e)):e!==z&&(a[j]=e))}return a}function s(a,c){var d=[],b;arguments.length==2?(b=a,a=c):b=this;if(h.isArr(b))d=A(b,a);else{var d={},e;for(e in b)h.isFun(b[e])||(d[e]=a.call(this,b[e]))}return d}function B(a){q++;for(var c=0,d=a.length;c<d;c++)a[c].constructor("i",q)}var z,m=Array.prototype.slice,t=Object.prototype.toString,u={},C={},q=0,h={isFun:function(a){return!(!a||!a.constructor||!a.call||!a.apply)},isStr:function(a){return!!(a===""||a&&a.charCodeAt&&a.substr)},
isNum:function(a){return t.call(a)==="[object Number]"},isArr:[].isArray||function(a){return t.call(a)==="[object Array]"},isObj:function(a){return a==null?String(a)=="object":t.call(a)==="[object Object]"||!0}},p=[].indexOf?function(a,c){return a.indexOf(c)}:function(a,c){for(var d=a.length-1;d!=-1&&c!=a[d];d--);return d},A=[].map?function(a,c){return a.map(c)}:function(a,c){for(var d=[],b=0,e=obj.length;b<e;b++)d.push(c(obj[b],b));return d},j=[].forEach?function(a,c){if(h.isArr(a))a.forEach(c);
else for(var d in a)c(d,a[d])}:function(a,c){if(h.isArr(a))for(var d=0,b=a.length;d<b;d++)c(a[d],d);else for(d in a)c(d,a[d])};j("< <= > >= == === != !==".split(" "),function(a){C[a]=Function("rhs","return function(x){return x"+a+"rhs}")});var D=function(){var a={};return function(c,d){var b,e=arguments.length,f=e==1?c:d||[],g={};f.length?f.length<20&&h.isNum(f[0])?(b=f.join(","),b=a[b]?a[b]:a[b]=new Function("x","return x=="+f.join("||x=="))):b=function(a){return p(f,a)>-1}:b=h.isFun(f)?function(a){return p(f(),
a)>-1}:f;return e==2?(g={},g[c]=b,g):b}}(),H=function(){var a=/^\s*([=<>!]+)['"]*(.*)$/,c,d={};return function(){return function(b,e){var f,g;if(h.isStr(b)){g=b;if(arguments.length==1)if(d[g])f=d[g];else{try{f=new Function("x,rec","return x "+g)}catch(j){f={}}try{f.single=new Function("rec","return "+b)}catch(m){}d[g]=f}arguments.length==2&&h.isStr(e)&&(f={},g=e,d[g]||(d[g]=(c=g.match(a))!==null?C[c[1]](c[2].replace(/['"]$/,"")):new Function("x,rec","return x "+g)),f[b]=d[g]);return f}}}}(),I=function(a){var c=
{};j(a,function(a){c[a]=!0});return c}("has hasKey insert invert missing isin group remove update where select find sort order each like".split(" "));self.DB=function(a,c){function d(){l||(l=!0,j(g,function(a){a.call(i,k)}),l=!1)}function b(a){for(var b in I)a[b]=i[b];return a}function e(a){for(var b=[],d=0,c=a.length;d<c;d++)b[d]=k[a[d]];return b}var f={},g=[],l=!1,o=!1,i=H(),k=[];n(i,{constrain:function(){var a=n,b=f,d;var c=arguments,e={};c.length==2?(e[c[0]]=c[1],d=e):c.length==1&&(d=c[0]);a(b,
d)},each:s,findFirst:function(){var a=i.find.apply(this,m.call(arguments));return a.length?a[0]:{}},has:F,hasKey:function(){return i.find(v.apply(this,m.call(arguments))).invert()},isin:D,like:w,invert:function(a){var d=k,c=[];B(a||this);for(var a=0,e=d.length;a<e;a++)d[a].constructor("i")!=q&&c.push(d[a]);return b(c)},map:s,missing:function(){return i.find(v.apply(this,m.call(arguments)))},sync:function(a){g.push(a)},template:{create:function(a){o=a},update:function(a){n(o||{},a)},get:function(){return o},
destroy:function(){o=!1}},update:function(){var a=G.apply(h.isArr(this)?this:i.find(),m.call(arguments));d();return b(a)}});i.group=function(a){var d={},c=h.isArr(this)?this:i.find();j(c,function(c){a in c&&(d[c[a]]||(d[c[a]]=b([])),d[c[a]].push(c))});return d};i.order=i.sort=function(a,d){var c,e=arguments.length,f,g=h.isArr(this)?this:i.find();h.isFun(a)?c=a:h.isStr(a)&&(e==1?f="x-y":e==2&&(f=h.isStr(d)?{asc:"x-y",desc:"y-x"}[d.toLowerCase()]:d),h.isStr(f)&&(f=u[f]?u[f]:u[f]=new Function("x,y",
"return "+f)),c=function(d,b){return f(d[a],b[a])});return b(m.call(g).sort(c))};i.where=i.find=function(){return b(r.apply(this,arguments.length?[k].concat(m.call(arguments)):[k]))};i.view=function(a){var b={};i.sync(function(d){var c={},e;j(d,function(b){a in b&&(c[b[a]]=b)});for(e in c)e in b?b[e]!==c[e]&&(b[e]=c[e]):b[e]=c[e];for(e in b)e in c||delete b[e]});d();return b};i.select=function(a){var d=h.isArr(this)?this:i.find(),c={};arguments.length>1?a=m.call(arguments):h.isStr(a)&&(a=[a]);j(a,
function(a,b){if(a=="*")c=A(d,y);else for(var e=0,f=d.length;e<f;e++)row=d[e],a in row&&(f>1?(c[e]||(c[e]=[]),c[e][b]=row[a]):c[e]=row[a])});return b(y(c))};i.insert=function(a){var c={},g=[],i=[];arguments.length>1?g=m.call(arguments):h.isArr(a)?g=a:g.push(a);j(g,function(a){if(f.unique&&(c={},j(k,function(a,b){c[a[f.unique]]=b}),a[f.unique]in c)){i.push(c[a[f.unique]]);return}var b=k.length,d;if(o){var e={};j(o,function(a,b){e[a]=h.isFun(b)?b():b});a=n(e,a)}try{d=new (x(b)),n(d,a),k.push(d)}catch(g){a.constructor=
x(b),k.push(a)}i.push(b)});d();return b(e(i))};i.remove=function(a,c){var e,f,g=[];e=h.isArr(this)?this:h.isArr(a)?a:arguments.length>0?i.find.apply(this,m.call(arguments)):i.find();B(e);var j=k.length-1;for(e=k.length;j>=0;j--)k[j].constructor("i")==q?g.push(k[j]):(e-(j+1)&&(f=j+1,k.splice(f,e-f)),e=j);f=j+1;e-f&&k.splice(f,e-f);d();return b(g.reverse())};if(arguments.length==1)if(h.isArr(a))i.insert(a);else if(h.isFun(a))i.insert(a());else if(h.isStr(a))return i.apply(this,arguments);else h.isObj(a)&&
i.insert(a);else arguments.length>1&&i.insert(m.call(arguments));i.__raw__=k;return i};n(DB,{find:r,each:s,like:w,isin:D,findFirst:function(){var a=r.apply(this,m.call(arguments));return a.length?a[0]:{}},reduceLeft:function(a,c){var d=h.isStr(c)?new Function("y,x","return y "+c):c;return function(b){for(var c=a,f=0,g=b.length;f<g;f++)b[f]&&(c=d(c,b[f]));return c}},reduceRight:function(a,c){c=DB.reduceLeft(a,c);return function(a){return c(a.reverse())}}})})();
