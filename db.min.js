(function(){function z(a,d){var b=arguments.length,c=b==1?a:d,i,e={};j.isArr(c)?(b=c.length,i=function(a){for(var e=0;e<b;e++)if(n(a,c[e])>-1)return!0;return!1}):i=function(a){return n(a,c)>-1};return b==2?(e={},e[a]=i,e):i}function t(a){return a.length?m.call(a):p(a)}function A(){var a=m.call(arguments),d,b,c,i,e,g,h,k={},f=t(j.isArr(this)?this:a.shift());a.length==2&&j.isStr(a[0])&&(c={},c[a[0]]=a[1],a=[o({},c)]);for(b=0;b<a.length;b++)if(d=a[b],j.isFun(d)){d=d.single;k={};e=f.length;for(h=e-1;h>=
0;h--){c=f[h];if(c in k){if(!k[c])continue}else if(!(k[c]=d(c)))continue;e-(h+1)&&(g=h+1,f.splice(g,e-g));e=h}g=h+1;e-g&&f.splice(g,e-g)}else l(d,function(a,b){if(j.isFun(b)){k={};e=f.length;for(h=e-1;h>=0;h--)c=f[h],a in c&&(i=c[a],b(i,c)&&(e-(h+1)&&(g=h+1,f.splice(g,e-g)),e=h))}else{e=f.length;for(h=e-1;h>=0;h--)c=f[h],a in c&&c[a]===b&&(e-(h+1)&&(g=h+1,f.splice(g,e-g)),e=h)}g=h+1;e-g&&f.splice(g,e-g)});return f}function B(a,d){var b,c=arguments.length,i,e={};c==1?i=a:c==2&&(i=d);i=i.toString().toLowerCase();
b=function(a){return a.toString().toLowerCase().search(i)>-1};return c==2?(e={},e[a]=b,e):b}function u(a){var d={x:a};return function(a,c){arguments.length==2&&(d[a]=c);return d[a]}}function q(a){var d={};l(a,function(a){d[a]=!0});return d}function p(a){var d=[],b;for(b in a)d.push(a[b]);return d}function o(a){for(var d,b,c,i,e=arguments.length,g=0;g<e;g++){d=arguments[g];for(var h in d)b=a[h],c=d[h],a!==c&&(c&&(c.constructor==Object||(i=j.isArr(c)))?(i?(i=!1,b=b&&j.isArr(constructor)?b:[]):b=b&&
b.constructor==Object?b:{},a[h]=o(b,c)):c!==void 0&&(a[h]=c))}return a}function C(a,d){var b=[],c;arguments.length==2?(c=a,a=d):c=this;if(j.isArr(c))b=v(c,a);else{var b={},i;for(i in c)j.isFun(c[i])||(b[i]=a.call(this,c[i]))}return b}var m=Array.prototype.slice,w=Object.prototype.toString,r={},x={},j={isFun:function(a){return!(!a||!a.constructor||!a.call||!a.apply)},isStr:function(a){return!!(a===""||a&&a.charCodeAt&&a.substr)},isArr:[].isArray||function(a){return w.call(a)==="[object Array]"},isObj:function(a){return a==
null?String(a)=="object":w.call(a)==="[object Object]"||!0}},n=[].indexOf?function(a,d){return a.indexOf(d)}:function(a,d){for(var b=a.length-1;b!=-1&&d!=a[b];b--);return b},D={}.keys||function(a){var d=[],b;for(b in a)d.push(b);return d},v=[].map?function(a,d){return a.map(d)}:function(a,d){for(var b=[],c=0,i=obj.length;c<i;c++)b.push(d(obj[c],c));return b},l=[].forEach?function(a,d){if(j.isArr(a))a.forEach(d);else for(var b in a)d(b,a[b])}:function(a,d){if(j.isArr(a))for(var b=0,c=a.length;b<c;b++)d(a[b],
b);else for(b in a)d(b,a[b])};l("< <= > >= == === != !==".split(" "),function(a){x[a]=Function("rhs","return function(x){return x"+a+"rhs}")});var E=function(){var a={};return function(d,b){var c,i=arguments.length,e=i==1?d:b,g={};e.length?e.length<20?(c=e.join(","),c=a[c]?a[c]:a[c]=new Function("x","return x=="+e.join("||x=="))):c=function(a){return n(e,a)>-1}:c=j.isFun(e)?function(a){return n(e(),a)>-1}:e;return i==2?(g={},g[d]=c,g):c}}(),F=function(){var a=/^\s*([=<>!]+)['"]*(.*)$/,d,b={};return function(){return function(c,
i){var e,g;if(j.isStr(c)){g=c;if(arguments.length==1)if(b[g])e=b[g];else{try{e=new Function("x,rec","return x "+g)}catch(h){e={}}try{e.single=new Function("rec","return "+c)}catch(k){}b[g]=e}arguments.length==2&&j.isStr(i)&&(e={},g=i,b[g]||(b[g]=(d=g.match(a))!==null?x[d[1]](d[2].replace(/['"]$/,"")):new Function("x,rec","return x "+g)),e[c]=b[g]);return e}}}}();(function(){var a={},d=(Math.random()*Math.pow(2,32)).toString(36),b=1,c;a.stain=function(a){b++;c=d+b;for(var e=0,g=a.length;e<g;e++)a[e][c]=
!0;return c};a.isStained=function(a){var b=a[c];b&&delete a[c];return b};return a})();var s=function(){var a={},d=0;a.stain=function(a){d++;for(var c=0,i=a.length;c<i;c++)a[c].constructor("i",d);return d};a.isStained=function(a){return a.constructor("i")==d};return a}();stainer=s;var G=q("has isin group remove update where select find order each like".split(" "));self.DB=function(a){function d(a){return a}function b(){for(var a=0,c=h.length;a<c;a++)h[a].call(f,k)}function c(a){for(var c in G)a[c]=
f[c];return a}function i(a){for(var c=[],b=0,e=a.length;b<e;b++)c[b]=k[a[b]];return c}var e={},g=0,h=[],k=[];k._indexCache={};var f=F();f.isin=E;f.has=z;f.like=B;f.each=C;f.group=function(a){var b={};filter=j.isArr(this)?this:f.find();l(filter,function(c){b[c[a]]||(b[c[a]]=[]);b[c[a]].push(c)});return c(b)};f.sync=function(a){h.push(a)};f.order=function(a,c){var b,e=arguments.length,d;j.isFun(a)?b=a:j.isStr(a)&&(e==1?d="x-y":e==2&&(j.isStr(c)&&(c.toLowerCase()=="asc"?d="x-y":c.toLowerCase()=="desc"&&
(d="y-x")),typeof d=="undefined"&&(d=c)),j.isStr(d)&&(d=r[d]?r[d]:r[d]=new Function("x,y","return "+d)),b=function(c,b){return d(c[a],b[a])});return(j.isArr(this)?this:f.find()).sort(b)};f.constrain=function(){var a=o,c=e,b;var d=arguments,f={};d.length==2?(f[d[0]]=d[1],b=f):d.length==1&&(b=d[0]);e=a(c,b)};f.inverse=function(a){arguments.length==0&&j.isArr(this)&&(a=this);var b;b=k;var d=a;b=q(b);var d=q(d),e;for(e in d)b[e]&&delete b[e];b=D(b);return c(b)};f.where=f.find=function(){return c(A.apply(this,
arguments.length?[k].concat(m.call(arguments)):[k]))};f.select=function(a){var b,d={};arguments.length>1?a=m.call(arguments):j.isStr(a)&&(a=[a]);b=j.isArr(this)?this:f.find();l(a,function(a,c){if(a=="*")d=v(b,p);else for(var e=0,f=b.length;e<f;e++)row=b[e],a in row&&(f>1?(d[e]||(d[e]=[]),d[e][c]=row[a]):d[e]=row[a])});return c(p(d))};f.insert=function(a){var f=[],h=[],y=[];arguments.length>1?h=m.call(arguments):j.isArr(a)?h=a:h.push(a);e.unique&&(f=db.find().select(e.unique));l(h,function(a){if(!(e.unique&&
n(f,a[e.unique])!=-1)){var b=g++,c;try{c=new (u(b)),o(c,a),k.push(c)}catch(d){if(!unsafe)a.constructor=u(b);k.push(a)}y.push(b)}});b();return c(d(i(y)))};f.update=function(a,d){var e,g;e=j.isArr(this)?t(this):f.find();arguments.length==2&&j.isStr(a)&&(g=a,a={},a[g]=d);l(a,function(a,b){j.isFun(b)?l(e,function(c){c[a]=b(c)}):l(e,function(c){c[a]=b})});b();return c(e)};f.remove=function(a){var d,e,g=[];d=j.isArr(this)?this:j.isArr(a)?a:arguments.length>0?f.find(a):f.find();s.stain(d);d=k.length;for(var h=
k.length-1;h>=0;h--)s.isStained(k[h])?g.push(k[h]):(d-(h+1)&&(e=h+1,k.splice(e,d-e)),d=h);e=h+1;d-e&&k.splice(e,d-e);b();return c(g)};if(arguments.length==1)if(j.isArr(a))f.insert(a);else if(j.isFun(a))f.insert(a());else if(j.isStr(a))return f.apply(this,arguments);else j.isObj(a)&&f.insert(a);else arguments.length>1&&f.insert(m.call(arguments));f.__raw__=k;return f}})();
